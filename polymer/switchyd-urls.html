<link rel='import' href='../bower_components/polymer/polymer.html'>

<link rel='import' href='../polymer/switchyd-list-page.html'>
<link rel='import' href='../polymer/switchyd-active-page-animaiton-behavior.html'>

<dom-module id='switchyd-urls'>
    
    <template>
        <switchyd-list-page id='page'
            items='{{_urls}}'
            notification='Host/Site/URL Config Save & Applied'
            on-start-sync='_sync'>
Note: Current proxy/whitelist sits here.

Example:
* www.google.com 
> fully qulified sites

* *.google.com
> match sits that ends with google.com
> proxy via a *HTTP/HTTPS/SPDY* proxy,using given server ip and port 
        </switchyd-list-page>
    </template>

    <script>
        Polymer({
            is : 'switchyd-urls',    
            
            properties : {
                tracer : {
                    type : String,

                    value : 'proxy',
                }
            },

            behaviors : [SwitchydActivePageAnimationBehaviro],
            
            ready : function(){
                var self = this;
                chrome.runtime.getBackgroundPage(function(page){
                    self._reloadURLs(page.switchyd);
                });
            },
            
            _urls : [],
            
            _reloadURLs : function(switchyd){
                var urls = switchyd.expand(switchyd.config.tracers[this.tracer]);
                
                // ensure urls not empty
                if( urls.length <= 0 ){
                    urls = [ this.tracer + '.google.com' ];
                }

                this._urls = urls;
            },

            _sync : function(){
                var self = this;
                chrome.runtime.getBackgroundPage(function(page){
                    var switchyd = page.switchyd;

                    var workspace = switchyd.tracer(self.tracer+'-workspace');
                    workspace.urls = {};
                    self._urls.forEach(function(url){
                        workspace.track(url);
                    });

                    // compile and optimize
                    switchyd.config.tracers[self.tracer] = switchyd.optimize(switchyd.compile(workspace));
                    // activate
                    switchyd.sync.save();
                    switchyd.async.enqueue();

                    self.$.page.syncDone();
                });
            },
        });
    </script>
</dom-module>
