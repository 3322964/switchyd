<link rel='import' href='../bower_components/polymer/polymer.html'>

<link rel='import' href='../polymer/switchyd-list-page.html'>
<link rel='import' href='../polymer/switchyd-active-page-animaiton-behavior.html'>

<dom-module id='switchyd-rules'>
    <template>
        <switchyd-list-page id='page'
            items='{{_rules}}'
            notification='Inception Rules Save & Applied'
            on-start-sync='_sync'>
Note: Network failues that considered to be solved by adding sites to proxy list.

Example:
* net::ERR_CONNECTION_RESET 
> the commonly seen GFW caused failue 
        </switchyd-list-page>
    </template>
    
    <script>
        Polymer({
            is : 'switchyd-rules',

            behaviors : [SwitchydActivePageAnimationBehaviro],

            ready : function(){
                var self = this;
                chrome.runtime.getBackgroundPage(function(page){
                    self._reloadRules(page.switchyd);
                });
            },
            
            _reloadRules : function(switchyd){
                var rules = [];
                for(var rule in switchyd.config.rules){
                    rules.push(rule);
                }

                if( rules.length <= 0 ){
                    rules = ['net::ERR_CONNECTION_RESET'];
                }

                this._rules = rules;
            },
            
            _rules : [],
            
            _sync : function(){
                var rules = {
                    'net::ERR_CONNECTION_RESET':0, 
                };

                this._rules.forEach(function(rule){
                    rules[rule]=0;
                });
                
                var self = this;
                chrome.runtime.getBackgroundPage(function(page){
                    var switchyd = page.switchyd;
                    switchyd.config.rules = rules;

                    switchyd.sync.save();

                    self.$.page.syncDone();
                });
            },
        });
    </script>
</dom-module>

