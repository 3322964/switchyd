<link rel='import' href='../bower_components/polymer/polymer.html'>

<link rel='import' href='../polymer/switchyd-list-page.html'>
<link rel='import' href='../polymer/switchyd-active-page-animaiton-behavior.html'>

<dom-module id='switchyd-servers'>
    
    <template>
        <switchyd-list-page id='page'
            items='{{_servers}}'
            notification='Proxy Server Config Save & Applied'
            on-start-sync='_sync'>
Note: Set proxy servers here.

Example:
*  SOCKS5 127.0.0.1:10086 
> proxy via local port 10086,using *SOCKS5* 

*  PROXY 192.168.1.179:80 
> proxy via a *HTTP/HTTPS/SPDY* proxy,using given server ip and port 
        </switchyd-list-page>
    </template>

    <script>
        'use strict';
        Polymer({
            is : 'switchyd-servers',
            
            behaviors : [SwitchydActivePageAnimationBehaviro],
            
            ready : function(){
                var self = this;
                chrome.runtime.getBackgroundPage(function(page){
                    self._reloadServers(page.switchyd);
                });
            },

            _servers : [],
            
            _reloadServers : function(switchyd){
                // ensure not empty
                if(switchyd.config.servers.length < 1){
                    page.switchyd.config.servers.push({
                        type : 'SOCKS5',
                        ip : '127.0.0.1',
                        port : 10086,
                    });
                }
                
                this._servers = switchyd.config.servers.map(function(item){
                    return item.type + ' ' +  item.ip + ':' + item.port;
                });
            },

            _sync : function(event){
                // parse config
                var configs = this._servers.map(function(item){
                    var tuple = item.trim().split(' ');
                    
                    if(tuple.length != 2){
                        console.warn('server config should in the form "PROTOCOL IP:PORT",'+'but got:'+item);
                        return undefined;
                    }

                    // parse type
                    var type = tuple[0].toUpperCase();
                    
                    // parse ip
                    var ip_and_port = tuple[1].split(':');
                    
                    // prepared
                    var ip = ip_and_port[0];
                    
                    // check if port presented
                    if(ip_and_port.length < 2 || ip_and_port[1].trim().length == 0){
                        // no port
                        return {
                            type : type,
                            ip : ip,
                            port : 80,
                        };
                    }else{
                        return {
                            type : type,
                            ip : ip,
                            port : ip_and_port[1],
                        }
                    }
                }).filter(function(item){ return item !== undefined});
                
                var self = this;
                // sync config
                chrome.runtime.getBackgroundPage(function(page){
                    page.switchyd.config.servers = configs;
                    
                    // notify sync done
                    self.$.page.syncDone();
            
                    // show toast
                    page.switchyd.sync.save();
                });
            }
        });
    </script>
</dom-module>

